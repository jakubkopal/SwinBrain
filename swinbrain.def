Bootstrap: docker
From: nvcr.io/nvidia/pytorch:23.10-py3

%environment
    export PYTHONUNBUFFERED=1
    export PIP_DISABLE_PIP_VERSION_CHECK=1
    export PIP_NO_CACHE_DIR=1

%post
    set -eux
    apt-get update
    apt-get install -y --no-install-recommends \
        git ca-certificates \
        libglib2.0-0 libsm6 libxext6 libxrender1
    rm -rf /var/lib/apt/lists/*

    python -m pip install --upgrade pip setuptools wheel

    # Important: avoid NumPy 2 on many stacks
    python -m pip install "numpy<2"

    # Install SwinBrain deps
    mkdir -p /opt/swinbrain
    python -m pip install -r /opt/swinbrain/requirements.txt

    # Re-enforce numpy<2 if something upgraded it
    python -m pip install --upgrade --force-reinstall "numpy<2"

%files
    requirements.txt /opt/swinbrain/requirements.txt

%runscript
    exec python "$@"

